<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ログイン - PSA代行サービス</title>

    <!-- React & React DOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <!-- Babel Standalone for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- デフォルトスタイル -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
                'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
                sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #root {
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
        }

        .login-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
        }

        .login-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .login-header h1 {
            font-size: 28px;
            font-weight: 700;
            color: #1a202c;
            margin-bottom: 8px;
        }

        .login-header p {
            color: #718096;
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 600;
            color: #2d3748;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            font-size: 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            transition: all 0.3s ease;
            outline: none;
        }

        .form-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-input:disabled {
            background: #f7fafc;
            cursor: not-allowed;
        }

        .btn {
            width: 100%;
            padding: 14px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            outline: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #f7fafc;
            color: #4a5568;
            border: 1px solid #e2e8f0;
            margin-top: 12px;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #edf2f7;
        }

        .btn-text {
            background: transparent;
            color: #667eea;
            padding: 8px;
            margin-top: 12px;
            font-size: 14px;
        }

        .btn-text:hover {
            text-decoration: underline;
        }

        .error-message {
            background: #fed7d7;
            color: #c53030;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            text-align: center;
        }

        .success-message {
            background: #c6f6d5;
            color: #22543d;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            text-align: center;
        }

        .info-message {
            background: #e6fffa;
            color: #234e52;
            padding: 12px;
            border-radius: 8px;
            margin-top: 20px;
            font-size: 14px;
            text-align: center;
        }

        /* OTP入力フィールド */
        .otp-container {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin-bottom: 24px;
        }

        .otp-input {
            flex: 1;
            max-width: 50px;
            height: 50px;
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            transition: all 0.3s ease;
            outline: none;
        }

        .otp-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .otp-input:disabled {
            background: #f7fafc;
            cursor: not-allowed;
        }

        /* ローディングスピナー */
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
            vertical-align: middle;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            color: #667eea;
            text-decoration: none;
            font-size: 14px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .back-link:hover {
            color: #764ba2;
        }

        .back-link svg {
            margin-right: 4px;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- Loginコンポーネント -->
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const Login = () => {
            // 状態管理
            const [step, setStep] = useState('email'); // 'email' または 'otp'
            const [email, setEmail] = useState('');
            const [otp, setOtp] = useState(['', '', '', '', '', '']);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            const [success, setSuccess] = useState('');
            const [resendCooldown, setResendCooldown] = useState(0);

            // OTP入力フィールドのref
            const otpRefs = useRef([]);

            // 再送信クールダウンタイマー
            useEffect(() => {
                if (resendCooldown > 0) {
                    const timer = setTimeout(() => {
                        setResendCooldown(resendCooldown - 1);
                    }, 1000);
                    return () => clearTimeout(timer);
                }
            }, [resendCooldown]);

            // 認証トークンが既にある場合はマイページにリダイレクト
            useEffect(() => {
                const token = localStorage.getItem('kanucard_auth_token');
                if (token) {
                    window.location.href = '/mypage.html';
                }
            }, []);

            // メールアドレス送信
            const handleSendOTP = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                setSuccess('');

                try {
                    const response = await fetch('/api/auth/verify-shopify-customer', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email })
                    });

                    const data = await response.json();

                    if (!data.success) {
                        throw new Error(data.message || '認証コードの送信に失敗しました');
                    }

                    setStep('otp');
                    setSuccess('認証コードをメールで送信しました。メールをご確認ください。');
                    setResendCooldown(60); // 60秒の再送信クールダウン

                    // 最初のOTP入力フィールドにフォーカス
                    setTimeout(() => {
                        if (otpRefs.current[0]) {
                            otpRefs.current[0].focus();
                        }
                    }, 100);
                } catch (err) {
                    setError(err.message || '認証コードの送信に失敗しました');
                } finally {
                    setLoading(false);
                }
            };

            // OTP検証
            const handleVerifyOTP = async (e) => {
                e.preventDefault();
                const otpCode = otp.join('');

                if (otpCode.length !== 6) {
                    setError('6桁の認証コードを入力してください');
                    return;
                }

                setLoading(true);
                setError('');
                setSuccess('');

                try {
                    const response = await fetch('/api/auth/verify-otp', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, otp: otpCode })
                    });

                    const data = await response.json();

                    if (!data.success) {
                        throw new Error(data.message || '認証コードが正しくありません');
                    }

                    // トークンとユーザーデータを保存
                    localStorage.setItem('kanucard_auth_token', data.token);
                    localStorage.setItem('kanucard_user_data', JSON.stringify(data.user));

                    setSuccess('ログインに成功しました！マイページへ移動します...');

                    // マイページへリダイレクト
                    setTimeout(() => {
                        window.location.href = '/mypage.html';
                    }, 1500);
                } catch (err) {
                    setError(err.message || '認証コードが正しくありません');
                    // エラー時はOTPをクリア
                    setOtp(['', '', '', '', '', '']);
                    if (otpRefs.current[0]) {
                        otpRefs.current[0].focus();
                    }
                } finally {
                    setLoading(false);
                }
            };

            // OTP入力処理
            const handleOtpChange = (index, value) => {
                // 数字以外は入力させない
                if (!/^[0-9]$/.test(value) && value !== '') return;

                const newOtp = [...otp];
                newOtp[index] = value;
                setOtp(newOtp);

                // 自動フォーカス移動
                if (value && index < 5) {
                    otpRefs.current[index + 1].focus();
                }

                // 6桁全て入力されたら自動送信
                if (newOtp.every(digit => digit !== '') && newOtp.join('').length === 6) {
                    const event = { preventDefault: () => {} };
                    handleVerifyOTP(event);
                }
            };

            // OTPフィールドでのキー処理
            const handleOtpKeyDown = (index, e) => {
                if (e.key === 'Backspace' && !otp[index] && index > 0) {
                    // 現在のフィールドが空でBackspaceが押されたら前のフィールドに移動
                    otpRefs.current[index - 1].focus();
                } else if (e.key === 'ArrowLeft' && index > 0) {
                    // 左矢印キーで前のフィールドに移動
                    otpRefs.current[index - 1].focus();
                } else if (e.key === 'ArrowRight' && index < 5) {
                    // 右矢印キーで次のフィールドに移動
                    otpRefs.current[index + 1].focus();
                }
            };

            // ペースト処理
            const handleOtpPaste = (e) => {
                e.preventDefault();
                const pastedData = e.clipboardData.getData('text').replace(/[^0-9]/g, '').slice(0, 6);
                if (pastedData.length === 6) {
                    const newOtp = pastedData.split('');
                    setOtp(newOtp);
                    // 最後のフィールドにフォーカス
                    otpRefs.current[5].focus();
                    // 自動送信
                    setTimeout(() => {
                        const event = { preventDefault: () => {} };
                        handleVerifyOTP(event);
                    }, 100);
                }
            };

            // メールアドレス変更
            const handleChangeEmail = () => {
                setStep('email');
                setOtp(['', '', '', '', '', '']);
                setError('');
                setSuccess('');
            };

            // 認証コード再送信
            const handleResendOTP = async () => {
                if (resendCooldown > 0) return;

                setLoading(true);
                setError('');
                setSuccess('');

                try {
                    const response = await fetch('/api/auth/verify-shopify-customer', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email })
                    });

                    const data = await response.json();

                    if (!data.success) {
                        throw new Error(data.message || '認証コードの再送信に失敗しました');
                    }

                    setSuccess('認証コードを再送信しました。メールをご確認ください。');
                    setResendCooldown(60);
                    setOtp(['', '', '', '', '', '']);

                    if (otpRefs.current[0]) {
                        otpRefs.current[0].focus();
                    }
                } catch (err) {
                    setError(err.message || '認証コードの再送信に失敗しました');
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="login-container">
                    <div className="login-header">
                        <h1>ログイン</h1>
                        <p>PSA代行サービス マイページ</p>
                    </div>

                    {step === 'email' ? (
                        <form onSubmit={handleSendOTP}>
                            <div className="form-group">
                                <label className="form-label" htmlFor="email">
                                    メールアドレス
                                </label>
                                <input
                                    id="email"
                                    type="email"
                                    className="form-input"
                                    value={email}
                                    onChange={(e) => setEmail(e.target.value)}
                                    placeholder="登録済みのメールアドレス"
                                    required
                                    disabled={loading}
                                    autoComplete="email"
                                    autoFocus
                                />
                            </div>

                            {error && <div className="error-message">{error}</div>}
                            {success && <div className="success-message">{success}</div>}

                            <button
                                type="submit"
                                className="btn btn-primary"
                                disabled={loading || !email}
                            >
                                {loading ? (
                                    <>
                                        <span className="spinner"></span>
                                        送信中...
                                    </>
                                ) : (
                                    '認証コードを送信'
                                )}
                            </button>

                            <div className="info-message">
                                Shopifyに登録されているメールアドレスを入力してください
                            </div>
                        </form>
                    ) : (
                        <form onSubmit={handleVerifyOTP}>
                            <a href="#" onClick={handleChangeEmail} className="back-link">
                                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                                    <path d="M11.354 1.646a.5.5 0 0 1 0 .708L5.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0z"/>
                                </svg>
                                メールアドレスを変更
                            </a>

                            <p style={{ marginBottom: '20px', color: '#4a5568', fontSize: '14px' }}>
                                <strong>{email}</strong> に認証コードを送信しました
                            </p>

                            <div className="form-group">
                                <label className="form-label">
                                    認証コード（6桁）
                                </label>
                                <div className="otp-container">
                                    {otp.map((digit, index) => (
                                        <input
                                            key={index}
                                            ref={el => otpRefs.current[index] = el}
                                            type="text"
                                            className="otp-input"
                                            maxLength={1}
                                            value={digit}
                                            onChange={(e) => handleOtpChange(index, e.target.value)}
                                            onKeyDown={(e) => handleOtpKeyDown(index, e)}
                                            onPaste={index === 0 ? handleOtpPaste : undefined}
                                            disabled={loading}
                                            autoComplete="off"
                                            inputMode="numeric"
                                            pattern="[0-9]"
                                        />
                                    ))}
                                </div>
                            </div>

                            {error && <div className="error-message">{error}</div>}
                            {success && <div className="success-message">{success}</div>}

                            <button
                                type="submit"
                                className="btn btn-primary"
                                disabled={loading || otp.join('').length !== 6}
                            >
                                {loading ? (
                                    <>
                                        <span className="spinner"></span>
                                        確認中...
                                    </>
                                ) : (
                                    'ログイン'
                                )}
                            </button>

                            <button
                                type="button"
                                className="btn btn-text"
                                onClick={handleResendOTP}
                                disabled={loading || resendCooldown > 0}
                            >
                                {resendCooldown > 0 ? (
                                    `認証コードを再送信（${resendCooldown}秒）`
                                ) : (
                                    '認証コードを再送信'
                                )}
                            </button>
                        </form>
                    )}
                </div>
            );
        };

        // Reactアプリケーションのレンダリング
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<Login />);
    </script>
</body>
</html>