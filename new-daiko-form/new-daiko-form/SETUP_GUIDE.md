# PSA代行統合システム セットアップガイド

## 📋 前提条件

- Node.js (v14以上)
- npm
- メール送信用のSMTPサーバー情報

## 🚀 インストール手順

### 1. プロジェクトのセットアップ

```bash
cd new-daiko-form
npm install
```

### 2. 環境変数の設定

`.env.example` をコピーして `.env` を作成：

```bash
cd src/config
cp .env.example .env
```

`.env` ファイルを編集してSMTP情報を設定：

```env
SMTP_HOST=your-smtp-host
SMTP_PORT=587
SMTP_USER=your-email@example.com
SMTP_PASS=your-password
FROM_EMAIL=your-email@example.com
ADMIN_EMAIL=your-email@example.com
```

### 3. SSL証明書の生成

開発環境用の自己署名証明書を生成：

```bash
cd src/config
openssl req -x509 -newkey rsa:4096 -keyout server.key -out server.crt -days 365 -nodes \
  -subj "/C=JP/ST=Tokyo/L=Tokyo/O=PSA Agency/CN=localhost"
```

**注意**: 本番環境では正式なSSL証明書を使用してください。

### 4. データディレクトリの確認

以下のディレクトリとファイルが存在することを確認：

```
src/data/
├── agency_requests.json
├── approval_requests.json
├── messages.json
└── backups/
```

## 🏃‍♂️ サーバー起動

### 開発モード（自動再起動）

```bash
npm run dev
```

### 本番モード

```bash
npm start
```

起動後、以下のメッセージが表示されます：

```
==================================================
🚀 PSA代行統合システム起動
==================================================
📍 HTTPサーバー: http://localhost:3000
📍 管理ダッシュボード: http://localhost:3000/admin
📍 ユーザー: admin / #collection30
==================================================

🔒 HTTPSサーバー: https://localhost:3443
```

## 🔍 動作確認

### 1. 利用者向けページの確認

ブラウザで http://localhost:3000/ にアクセス

- ✅ 代行依頼フォームが表示される
- ✅ カード追加ボタンが動作する
- ✅ テーマ切替ボタンでダークモード切り替えができる

### 2. 代行依頼のテスト

1. フォームに情報を入力：
   - お名前: テスト太郎
   - メール: test@example.com
   - カード情報を入力

2. 「代行依頼を送信」ボタンをクリック

3. 成功モーダルが表示される

4. マイページURLを確認

### 3. マイページの確認

1. マイページURLにアクセス

2. 以下が表示されることを確認：
   - ✅ 依頼ステータス
   - ✅ カード情報
   - ✅ 進捗タイムライン
   - ✅ メッセージ機能

### 4. 管理者ダッシュボードの確認

1. http://localhost:3000/admin にアクセス

2. Basic認証でログイン：
   - ユーザー名: `admin`
   - パスワード: `#collection30`

3. 以下の機能を確認：
   - ✅ 概要ページに統計が表示される
   - ✅ 代行案件タブで依頼一覧が表示される
   - ✅ 案件詳細が確認できる
   - ✅ ステータス変更ができる
   - ✅ メッセージタブでやり取りができる
   - ✅ バックアップタブでバックアップ作成ができる

### 5. メール送信のテスト

1. 代行依頼を送信

2. 以下のメールが届くことを確認：
   - ✅ 顧客向け確認メール（マイページURL付き）
   - ✅ 管理者向け通知メール

3. ステータス更新時のメール送信を確認

## 🐛 トラブルシューティング

### メールが送信されない

1. `.env` のSMTP設定を確認
2. `MAIL_DEBUG=true` に設定してログを確認
3. SMTPサーバーの認証情報が正しいか確認

### ポートが使用中

```bash
# ポート使用状況確認
lsof -i :3000
lsof -i :3443

# プロセス終了
kill -9 [PID]
```

### データが表示されない

```bash
# JSONファイルの内容確認
cat src/data/agency_requests.json
cat src/data/approval_requests.json
cat src/data/messages.json

# ファイル権限確認
ls -la src/data/
```

### SSL証明書エラー（開発環境）

ブラウザで「詳細設定」→「安全でないページに進む」を選択
（自己署名証明書のため）

## 📊 テストシナリオ

### シナリオ1: 代行依頼からメッセージのやり取り

1. **利用者**: 代行依頼を送信
2. **システム**: 確認メール送信
3. **利用者**: マイページにアクセス
4. **管理者**: ダッシュボードで依頼確認
5. **管理者**: ステータスを「作業中」に変更
6. **システム**: 顧客に通知メール送信
7. **利用者**: マイページでメッセージ送信
8. **管理者**: メッセージタブで返信
9. **管理者**: ステータスを「完了」に変更
10. **システム**: 完了通知メール送信

### シナリオ2: 買取承認フロー

1. **管理者**: 買取承認申請を作成・送信
2. **システム**: 顧客に承認メール送信
3. **顧客**: 承認URLにアクセス
4. **顧客**: カードごとに承認・拒否を選択
5. **顧客**: 回答を送信
6. **システム**: 管理者に結果通知メール送信
7. **管理者**: ダッシュボードで結果確認

## 🔐 セキュリティチェックリスト

- ✅ `.env` ファイルを `.gitignore` に追加
- ✅ 本番環境では正式なSSL証明書を使用
- ✅ 管理者パスワードを変更
- ✅ SMTPパスワードを安全に管理
- ✅ データファイルのバックアップを定期的に取得

## 📝 次のステップ

1. **本番環境へのデプロイ**
   - VPSまたはクラウドサーバーを準備
   - ドメインを設定
   - 正式なSSL証明書を取得
   - 環境変数を本番用に設定

2. **カスタマイズ**
   - ロゴ画像の追加
   - テーマカラーの変更
   - メールテンプレートの調整

3. **運用開始**
   - テスト運用で動作確認
   - 顧客への案内
   - 定期的なバックアップ確認

---

**問題が発生した場合**: README.mdのトラブルシューティングセクションを確認してください。
