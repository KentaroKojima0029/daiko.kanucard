<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>PSAä»£è¡Œã‚µãƒ¼ãƒ“ã‚¹ - ã‚«ãƒ¼ãƒ‰å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ </title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body, html {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 0;
      color: #2d3748;
      line-height: 1.6;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 20px 8px;
      min-height: 100vh;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .main-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 24px;
      box-shadow: 
        0 25px 50px -12px rgba(0, 0, 0, 0.25),
        0 0 0 1px rgba(255, 255, 255, 0.1);
      overflow: hidden;
      animation: slideUp 0.8s ease-out;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .form-content {
      padding: 32px 12px;
    }

    .section {
      margin-bottom: 32px;
    }

    .section-title {
      font-size: 20px;
      font-weight: 700;
      color: #1a202c;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .section-title::before {
      content: '';
      width: 4px;
      height: 20px;
      background: linear-gradient(135deg, #4f46e5, #7c3aed);
      border-radius: 2px;
    }

    .input-grid {
      display: grid;
      grid-template-columns: 4fr 4fr 2fr;
      gap: 8px;
      margin-bottom: 24px;
    }

    .input-group {
      display: flex;
      flex-direction: column;
    }

    .form-label {
      font-size: 14px;
      font-weight: 600;
      color: #374151;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .form-input {
      width: 100%;
      padding: 14px 16px;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 500;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      background: #ffffff;
      color: #1f2937;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      min-width: 0;
    }

    .form-select {
      width: 100%;
      padding: 14px 16px;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 500;
      background: #ffffff;
      color: #1f2937;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      min-width: 0;
    }

    .form-row .input-group,
    .choice-section,
    .input-group {
      flex: 1;
      min-width: 0;
    }

    .choice-buttons {
      display: flex;
      gap: 8px;
      width: 100%;
    }

    .choice-btn {
      flex: 1;
      padding: 16px 12px;
      border: none;
      border-radius: 12px;
      background: #ffffff;
      color: #374151;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      text-align: center;
      line-height: 1.4;
      min-height: 64px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      min-width: 0;
    }

    .form-input:focus {
      outline: none;
      box-shadow: 
        0 0 0 3px rgba(79, 70, 229, 0.1),
        0 4px 6px -1px rgba(0, 0, 0, 0.1);
      transform: translateY(-1px);
    }

    .form-input::placeholder {
      color: #9ca3af;
      font-weight: 400;
    }

    .input-hint {
      font-size: 12px;
      color: #6b7280;
      margin-top: 6px;
      font-weight: 500;
    }

    .button-container {
      display: flex;
      gap: 12px;
      margin-bottom: 24px;
    }

    .btn {
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      text-align: center;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      min-height: 48px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #4f46e5, #7c3aed);
      color: white;
      flex: 2;
      padding: 14px 20px;
      box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.3);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 15px -3px rgba(79, 70, 229, 0.4);
    }

    .btn-danger {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: white;
      flex: 1;
      padding: 14px 16px;
      box-shadow: 0 4px 6px -1px rgba(239, 68, 68, 0.3);
    }

    .btn-danger:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 15px -3px rgba(239, 68, 68, 0.4);
    }

    .btn-submit {
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
      padding: 18px 32px;
      font-size: 18px;
      font-weight: 700;
      width: 100%;
      margin: 32px 0;
      box-shadow: 0 6px 12px -2px rgba(16, 185, 129, 0.3);
    }

    .btn-submit:hover {
      transform: translateY(-3px);
      box-shadow: 0 12px 20px -4px rgba(16, 185, 129, 0.4);
    }

    .table-container {
      background: #ffffff;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      margin: 24px 0;
      border: 1px solid #e5e7eb;
    }

    .modern-table {
      width: 100%;
      border-collapse: collapse;
    }

    .modern-table th {
      background: linear-gradient(135deg, #f8fafc, #f1f5f9);
      padding: 16px 12px;
      font-size: 13px;
      font-weight: 700;
      color: #374151;
      text-align: center;
      border-bottom: 2px solid #e5e7eb;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .modern-table td {
      padding: 16px 12px;
      text-align: center;
      font-size: 14px;
      font-weight: 500;
      border-bottom: 1px solid #f3f4f6;
      color: #1f2937;
    }

    .modern-table tbody tr:hover {
      background: #f8fafc;
    }

    .modern-table .total-row {
      background: linear-gradient(135deg, #4f46e5, #7c3aed);
      color: white;
      font-weight: 700;
    }

    .modern-table .total-row td {
      border-bottom: none;
      font-size: 15px;
      color: white;
    }

    .card-name-cell {
      text-align: left !important;
      font-weight: 600;
      line-height: 1.4;
      max-width: 200px;
      word-break: break-word;
      white-space: pre-line;
    }

    .action-buttons {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 6px;
    }

    .menu-toggle {
      background: #f3f4f6;
      border: none;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 16px;
      color: #6b7280;
      transition: all 0.2s ease;
    }

    .menu-toggle:hover {
      background: #e5e7eb;
      color: #374151;
    }

    .menu-toggle.hidden {
      display: none;
    }

    .action-btn {
      padding: 6px 12px;
      border: none;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      display: none;
    }

    .action-btn.show {
      display: inline-block;
    }

    .action-btn.edit {
      background: #10b981;
      color: white;
    }

    .action-btn.edit:hover {
      background: #059669;
      transform: scale(1.05);
    }

    .action-btn.delete {
      background: #ef4444;
      color: white;
    }

    .action-btn.delete:hover {
      background: #dc2626;
      transform: scale(1.05);
    }

    .form-select:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-bottom: 24px;
    }

    .form-row .input-group {
      display: flex;
      flex-direction: column;
    }

    .form-row .form-select {
      width: 100%;
      min-height: 52px;
      padding: 14px 16px;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 500;
      background: #ffffff;
      color: #1f2937;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      min-width: 0;
    }

    .choice-section {
      margin-bottom: 24px;
    }

    .form-select:disabled {
      background-color: #f3f4f6;
      color: #9ca3af;
      cursor: not-allowed;
      opacity: 0.6;
    }

    .select-wrap.disabled::after {
      color: #9ca3af;
      opacity: 0.4;
    }

    .form-select {
      display: block;
      width: 100%;
      max-width: 100%;
      appearance: none;
      -webkit-appearance: none;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      padding-right: 40px;
    }

    .select-wrap {
      position: relative;
      width: 100%;
    }

    .select-wrap::after {
      content: "â–¾";
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      pointer-events: none;
      font-size: 14px;
      opacity: 0.6;
    }

    .form-row > .input-group,
    .form-row .form-input,
    .form-row .form-select,
    .select-wrap {
      width: 100%;
      max-width: 100%;
      min-width: 0;
    }

    .choice-label {
      font-size: 16px;
      font-weight: 700;
      color: #1a202c;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .choice-btn:hover {
      background: #f8fafc;
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    .choice-btn.active {
      border: none;
      background: linear-gradient(135deg, #4f46e5, #7c3aed);
      color: white;
      box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.3);
    }

    .choice-btn.gray.active {
      border: none;
      background: linear-gradient(135deg, #6b7280, #4b5563);
      color: white;
      box-shadow: 0 4px 6px -1px rgba(107, 114, 128, 0.3);
    }

    .choice-btn.blue.active {
      border: none;
      background: linear-gradient(135deg, #0ea5e9, #0284c7);
      color: white;
      box-shadow: 0 4px 6px -1px rgba(14, 165, 233, 0.3);
    }

    .confirmation-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(5px);
      z-index: 1000;
      overflow-y: auto;
      animation: fadeIn 0.3s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .confirmation-modal {
      background: white;
      margin: 40px auto;
      padding: 32px;
      border-radius: 20px;
      max-width: 600px;
      width: 90%;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      animation: slideUpModal 0.4s ease-out;
    }

    @keyframes slideUpModal {
      from {
        opacity: 0;
        transform: translateY(30px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .confirmation-header {
      text-align: left;
      margin-bottom: 24px;
    }

    .confirmation-header h3 {
      font-size: 24px;
      font-weight: 800;
      color: #1a202c;
      margin-bottom: 8px;
      text-align: left;
    }

    .fee-summary-card {
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
      padding: 24px;
      border-radius: 16px;
      margin: 20px 0;
      box-shadow: 0 8px 15px -3px rgba(16, 185, 129, 0.4);
    }

    .fee-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    }

    .fee-row.total {
      border-bottom: 2px solid rgba(255, 255, 255, 0.3);
      border-top: 2px solid rgba(255, 255, 255, 0.3);
      margin-top: 12px;
      padding-top: 16px;
      font-weight: 700;
      font-size: 18px;
    }

    .fee-row.normal {
      font-weight: 500;
      font-size: 14px;
    }

    .confirmation-details {
      background: #f8fafc;
      padding: 20px;
      border-radius: 12px;
      margin: 16px 0;
    }

    .confirmation-buttons {
      display: flex;
      gap: 12px;
      margin-top: 24px;
    }

    .btn-confirm {
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
      flex: 2;
      padding: 16px 24px;
      font-size: 16px;
      font-weight: 700;
    }

    .btn-cancel {
      background: linear-gradient(135deg, #6b7280, #4b5563);
      color: white;
      flex: 1;
      padding: 16px 16px;
      font-size: 16px;
      font-weight: 700;
    }

    .success-message {
      display: none;
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
      padding: 20px;
      border-radius: 16px;
      text-align: center;
      font-weight: 600;
      margin: 20px 0;
      box-shadow: 0 8px 15px -3px rgba(16, 185, 129, 0.4);
    }

    @media (max-width: 768px) {
      .container {
        padding: 12px 4px;
      }

      .form-content {
        padding: 24px 8px;
      }

      .input-grid {
        display: grid;
        grid-template-columns: 4fr 4fr 2fr;
        grid-template-rows: auto;
        gap: 6px;
      }

      .form-row {
        display: flex;
        gap: 8px;
      }

      .form-row .input-group {
        flex: 1;
      }

      .choice-buttons {
        gap: 6px;
      }

      .choice-btn {
        font-size: 13px;
        padding: 12px 8px;
        min-height: 56px;
      }

      .confirmation-modal {
        margin: 20px auto;
        padding: 24px 20px;
        width: 95%;
      }

      .confirmation-buttons {
        flex-direction: column;
        gap: 8px;
      }

      .modern-table th,
      .modern-table td {
        padding: 12px 6px;
        font-size: 12px;
      }

      .card-name-cell {
        max-width: 120px;
        font-size: 11px;
      }

      .form-select,
      .form-input {
        font-size: 16px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="main-card">
      <div class="form-content">
        <div class="section">
          <div class="section-title">ã‚«ãƒ¼ãƒ‰æƒ…å ±å…¥åŠ›</div>
          
          <form id="itemForm">
            <div class="input-group">
              <label class="form-label" for="searchItem">
                ğŸ´ ã‚«ãƒ¼ãƒ‰è©³ç´°æƒ…å ±
              </label>
              <input 
                type="text" 
                id="searchItem" 
                name="searchItem" 
                class="form-input"
                placeholder="ä¾‹ï¼šãƒ–ãƒ©ãƒƒã‚­ãƒ¼VMAX 2021 095/069 HR" 
                required
              >
              <div class="input-hint">ã‚«ãƒ¼ãƒ‰åãƒ»è£½é€ å¹´ãƒ»ç•ªå·ãƒ»ãƒ¬ã‚¢ãƒªãƒ†ã‚£ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>
            </div>
            
            <div class="input-grid">
              <div class="input-group">
                <label class="form-label" for="declaredValue">ğŸ’° ç”³å‘Šé¡ï¼ˆ1æšï¼‰</label>
                <input 
                  step="any" 
                  min="0" 
                  type="number" 
                  id="declaredValue" 
                  name="declaredValue" 
                  class="form-input"
                  placeholder="150000" 
                  required 
                  inputmode="numeric"
                >
                <div class="input-hint">1æšã‚ãŸã‚Šã®ç”³å‘Šé¡</div>
              </div>
              
              <div class="input-group">
                <label class="form-label" for="acquisitionValue">ğŸŒ å–å¾—é¡</label>
                <input 
                  step="any" 
                  min="0" 
                  type="number" 
                  id="acquisitionValue" 
                  name="acquisitionValue" 
                  class="form-input"
                  placeholder="200000" 
                  inputmode="numeric"
                >
                <div class="input-hint">é–¢ç¨15ï¼…è¨ˆç®—ç”¨ã®è·ç‰©ä¾¡æ ¼</div>
              </div>
              
              <div class="input-group">
                <label class="form-label" for="quantity">ğŸ“¦ æ•°é‡</label>
                <input 
                  type="number" 
                  id="quantity" 
                  name="quantity" 
                  class="form-input"
                  min="1" 
                  required 
                  inputmode="numeric"
                  placeholder="æš"
                >
                <div class="input-hint">ã‚«ãƒ¼ãƒ‰ã®æšæ•°</div>
              </div>
            </div>
            
            <div class="button-container">
              <button class="btn btn-primary" type="submit">
                <span>ğŸ’¾</span> ã‚«ãƒ¼ãƒ‰ã‚’ä¿å­˜
              </button>
              <button class="btn btn-danger" id="deleteDataButton" type="button">
                <span>ğŸ—‘ï¸</span> å…¨å‰Šé™¤
              </button>
            </div>
          </form>
        </div>

        <div class="section">
          <div class="section-title">ã‚«ãƒ¼ãƒ‰ä¸€è¦§</div>
          <div class="table-container">
            <table class="modern-table" id="itemsTable">
              <thead>
                <tr>
                  <th style="width: 8%;">No</th>
                  <th style="width: 35%;">ã‚«ãƒ¼ãƒ‰å</th>
                  <th style="width: 10%;">æ•°é‡</th>
                  <th style="width: 15%;">ç”³å‘Šé¡</th>
                  <th style="width: 15%;">å–å¾—é¡</th>
                  <th style="width: 17%;">æ“ä½œ</th>
                </tr>
              </thead>
              <tbody></tbody>
              <tfoot>
                <tr class="total-row">
                  <td colspan="3">åˆè¨ˆ</td>
                  <td id="totalQuantity">0æš</td>
                  <td colspan="2">ä»£è¡Œæ–™: <span id="totalFee">0å††</span></td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>

        <div class="section">
          <div class="section-title">ã‚µãƒ¼ãƒ“ã‚¹è¨­å®š</div>
          
          <form id="contactForm">
            <div class="form-row">
              <div class="input-group">
                <label class="form-label" for="plan">ğŸ“‹ ä»£è¡Œãƒ—ãƒ©ãƒ³</label>
                <div class="select-wrap">
                <select id="plan" name="plan" class="form-select">
                  <option value="normal">ãƒãƒ¼ãƒãƒ« æ—¥æœ¬ (2.2%)</option>
                  <option value="guarantee">70ï¼…ä¿è¨¼ æ—¥æœ¬ (3.3%)</option>
                  <option value="normal_usa">ãƒãƒ¼ãƒãƒ« ã‚¢ãƒ¡ãƒªã‚« (3.3%)</option>
                  <option value="guarantee_usa">70ï¼…ä¿è¨¼ ã‚¢ãƒ¡ãƒªã‚« (5.0%)</option>
                </select>
              </div>
              </div>
              
              <div class="input-group">
                <label class="form-label" for="serviceOption">â­ PSAç¤¾ãƒ—ãƒ©ãƒ³</label>
                <div class="select-wrap">
                <select id="serviceOption" name="serviceOption" class="form-select">
                  <option value="ãƒãƒªãƒ¥ãƒ¼ãƒãƒ«ã‚¯">ãƒãƒªãƒ¥ãƒ¼ãƒãƒ«ã‚¯</option>
                  <option value="ãƒãƒªãƒ¥ãƒ¼">ãƒãƒªãƒ¥ãƒ¼</option>
                  <option value="ãƒãƒªãƒ¥ãƒ¼ãƒ—ãƒ©ã‚¹">ãƒãƒªãƒ¥ãƒ¼ãƒ—ãƒ©ã‚¹</option>
                  <option value="ãƒ¬ã‚®ãƒ¥ãƒ©ãƒ¼">ãƒ¬ã‚®ãƒ¥ãƒ©ãƒ¼</option>
                  <option value="ãƒ‘ãƒƒã‚¯ãƒ»é›‘èªŒé‘‘å®š">ãƒ‘ãƒƒã‚¯ãƒ»é›‘èªŒé‘‘å®š</option>
                  <option value="ç‰¹æ®Šé‘‘å®š">ç‰¹æ®Šé‘‘å®š</option>
                  <option value="ãã‚Œä»¥å¤–">ãã‚Œä»¥å¤–</option>
                </select>
              </div>
          </div>
          </div>

            <div class="choice-section">
              <div class="choice-label">ğŸ’µ è²·å–é¡ã®æç¤º</div>
              <div class="choice-buttons">
                <button type="button" class="choice-btn" data-option="purchaseOffer" data-value="å¸Œæœ›ã™ã‚‹">
                  å¸Œæœ›ã™ã‚‹
                </button>
                <button type="button" class="choice-btn gray active" data-option="purchaseOffer" data-value="å¸Œæœ›ã—ãªã„">
                  å¸Œæœ›ã—ãªã„
                </button>
              </div>
              <input type="hidden" id="purchaseOffer" name="purchaseOffer" value="å¸Œæœ›ã—ãªã„">
            </div>

            <div class="choice-section">
              <div class="choice-label">ğŸ“® è¿”å´æ–¹æ³•</div>
              <div class="choice-buttons">
                <button type="button" class="choice-btn active" data-option="returnMethod" data-value="å³æ™‚è¿”é€">
                  å³æ™‚è¿”é€<br>ï¼ˆé€æ–™è² æ‹…ï¼‰
                </button>
                <button type="button" class="choice-btn blue" data-option="returnMethod" data-value="é‘‘å®šå“ã¨ä¸€ç·’ã«è¿”é€">
                  é‘‘å®šå“ã¨<br>ä¸€ç·’ã«è¿”é€
                </button>
              </div>
              <input type="hidden" id="returnMethod" name="returnMethod" value="å³æ™‚è¿”é€">
            </div>

            <div class="choice-section">
              <div class="choice-label">ğŸ” ç„¡æ–™æ¤œå“</div>
              <div class="choice-buttons">
                <button type="button" class="choice-btn active" data-option="inspectionOption" data-value="å¸Œæœ›ã™ã‚‹">
                  å¸Œæœ›ã™ã‚‹<br>ï¼ˆæ¨å¥¨ï¼‰
                </button>
                <button type="button" class="choice-btn gray" data-option="inspectionOption" data-value="å¸Œæœ›ã—ãªã„">
                  å¸Œæœ›ã—ãªã„
                </button>
              </div>
              <input type="hidden" id="inspectionOption" name="inspectionOption" value="å¸Œæœ›ã™ã‚‹">
            </div>

            <div class="form-row">
              <div class="input-group">
                <label class="form-label" for="contactName">ğŸ‘¤ ãŠåå‰</label>
                <input 
                  required 
                  id="contactName" 
                  name="contactName" 
                  type="text" 
                  class="form-input"
                  placeholder="å±±ç”°å¤ªéƒ"
                >
              </div>
              <div class="input-group">
                <label class="form-label" for="contactEmail">ğŸ“§ ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                <input 
                  required 
                  id="contactEmail" 
                  name="contactEmail" 
                  type="email" 
                  class="form-input"
                  placeholder="example@email.com"
                >
              </div>
            </div>

            <div class="input-group">
              <label class="form-label" for="contactBody">ğŸ’¬ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</label>
              <textarea 
                rows="4" 
                id="contactBody" 
                name="contact[body]" 
                class="form-input"
                placeholder="ã”è³ªå•ã‚„ã”è¦æœ›ãŒã”ã–ã„ã¾ã—ãŸã‚‰ã”è¨˜å…¥ãã ã•ã„"
              ></textarea>
            </div>

            <button type="submit" class="btn btn-submit">
              <span>ğŸ“‹</span> å†…å®¹ã‚’ç¢ºèªã™ã‚‹
            </button>
          </form>
        </div>
      </div>
    </div>

    <div class="confirmation-overlay" id="confirmationScreen">
      <div class="confirmation-modal">
        <div class="confirmation-header">
          <h3>ğŸ“‹ é€ä¿¡å†…å®¹ã®æœ€çµ‚ç¢ºèª</h3>
          <p style="color: #6b7280;">ä»¥ä¸‹ã®å†…å®¹ã§é€ä¿¡ã„ãŸã—ã¾ã™</p>
        </div>
        
        <div class="fee-summary-card">
          <div class="fee-row normal">
            <span>ä»£è¡Œæ‰‹æ•°æ–™</span>
            <span id="confirmAgencyFee">0å††</span>
          </div>
          <div class="fee-row normal">
            <span>è¦‹è¾¼é‘‘å®šæ–™</span>
            <span id="confirmEstimatedGradingFee">è¨­å®šã—ã¦ãã ã•ã„</span>
          </div>
          <div class="fee-row total">
            <span>æ”¯æ‰•ç·é¡ï¼ˆäºˆå®šé¡ï¼‰</span>
            <span id="confirmTotalEstimatedFee">-</span>
          </div>
        </div>
        
        <div style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; padding: 16px; border-radius: 12px; margin: 16px 0; box-shadow: 0 4px 8px -2px rgba(245, 158, 11, 0.3);">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <span style="font-size: 14px; font-weight: 500;">é–¢ç¨è¦‹è¾¼ã¿é¡ã€€â€»ç™ºç”Ÿæ™‚ã®ã¿</span>
            <span id="confirmEstimatedTax" style="font-weight: 600;">0å††</span>
          </div>
        </div>
        
        <div class="confirmation-details" id="confirmationDetails"></div>
        
        <div class="confirmation-buttons">
          <button type="button" class="btn btn-confirm" id="finalSendBtn">
            <span>ğŸ“¤</span> é€ä¿¡å®Ÿè¡Œ
          </button>
          <button type="button" class="btn btn-cancel" id="cancelBtn">
            <span>âŒ</span> ã‚­ãƒ£ãƒ³ã‚»ãƒ«
          </button>
        </div>
        
        <div style="background: #f8fafc; border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; margin-top: 16px; text-align: center; font-size: 14px; color: #6b7280; line-height: 1.5;">
          <p style="margin: 0 0 8px 0;">é€ä¿¡å¾Œã€ãƒ•ã‚©ãƒ¼ãƒ ã«å…¥åŠ›ã—ãŸã‚¢ãƒ‰ãƒ¬ã‚¹ã«ç¢ºèªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå±Šãã¾ã™ã€‚</p>
          <p style="margin: 0;">ä¿®æ­£ã—ãŸã„å ´åˆã¯ã€ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚</p>
        </div>
      </div>
    </div>

    <div class="success-message" id="confirmationMessage">
      âœ… ãŠç”³ã—è¾¼ã¿ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸï¼<br>
      ç¢ºèªãƒ¡ãƒ¼ãƒ«ã‚’ãŠé€ã‚Šã„ãŸã—ã¾ã—ãŸã®ã§ã€ä»Šã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚
    </div>
  </div>

  <script>
    let editIndex = null;
    let originalPlanOptions;

    function calculateGradingFee(serviceOption, totalQuantity, plan) {
      const japanFees = {
        "ãƒãƒªãƒ¥ãƒ¼ãƒãƒ«ã‚¯": 3300,
        "ãƒãƒªãƒ¥ãƒ¼": 4300,
        "ãƒãƒªãƒ¥ãƒ¼ãƒ—ãƒ©ã‚¹": 6300,
        "ãƒ¬ã‚®ãƒ¥ãƒ©ãƒ¼": 9300
      };
      
      const usaFees = {
        "ãƒãƒªãƒ¥ãƒ¼ãƒãƒ«ã‚¯": 3900,
        "ãƒãƒªãƒ¥ãƒ¼": 5000,
        "ãƒãƒªãƒ¥ãƒ¼ãƒ—ãƒ©ã‚¹": 7200,
        "ãƒ¬ã‚®ãƒ¥ãƒ©ãƒ¼": 13500
      };
      
      const isUSA = plan === "normal_usa" || plan === "guarantee_usa";
      const fees = isUSA ? usaFees : japanFees;
      
      if (fees[serviceOption]) {
        return fees[serviceOption] * totalQuantity;
      } else {
        return null;
      }
    }

    function truncateCardName(text, maxCharsPerLine = 30, maxLines = 2) {
      function getStringWidth(str) {
        let width = 0;
        for (let i = 0; i < str.length; i++) {
          const char = str.charAt(i);
          if (char.match(/[^\x01-\x7E]/)) {
            width += 2;
          } else {
            width += 1;
          }
        }
        return width;
      }

      function truncateByWidth(str, maxWidth) {
        let result = '';
        let currentWidth = 0;
        
        for (let i = 0; i < str.length; i++) {
          const char = str.charAt(i);
          const charWidth = char.match(/[^\x01-\x7E]/) ? 2 : 1;
          
          if (currentWidth + charWidth <= maxWidth) {
            result += char;
            currentWidth += charWidth;
          } else {
            break;
          }
        }
        return result;
      }

      const words = text.split(' ');
      const lines = [];
      let currentLine = '';
      
      for (const word of words) {
        const testLine = currentLine ? currentLine + ' ' + word : word;
        
        if (getStringWidth(testLine) <= maxCharsPerLine) {
          currentLine = testLine;
        } else {
          if (currentLine) {
            lines.push(currentLine);
            currentLine = word;
          } else {
            lines.push(truncateByWidth(word, maxCharsPerLine));
            currentLine = '';
          }
          
          if (lines.length >= maxLines) {
            break;
          }
        }
      }
      
      if (currentLine && lines.length < maxLines) {
        lines.push(currentLine);
      }

      if (lines.length === maxLines && words.length > lines.join(' ').split(' ').length) {
        const lastLine = lines[maxLines - 1];
        const truncatedLastLine = truncateByWidth(lastLine, maxCharsPerLine - 3) + '...';
        lines[maxLines - 1] = truncatedLastLine;
      }

      return lines.join('\n');
    }

    function truncateCardNameForConfirmation(text, maxCharsPerLine = 70, maxLines = 2) {
      return truncateCardName(text, maxCharsPerLine, maxLines);
    }

    function toggleButtons(index, event) {
      event.stopPropagation();
      
      document.querySelectorAll('.action-btn').forEach(btn => {
        if (!btn.id.includes(`-${index}`)) {
          btn.classList.remove('show');
        }
      });
      document.querySelectorAll('.menu-toggle').forEach(toggle => {
        if (toggle.id !== `menu-${index}`) {
          toggle.classList.remove('hidden');
        }
      });
      
      const menuToggle = document.getElementById(`menu-${index}`);
      const editBtn = document.getElementById(`edit-${index}`);
      const deleteBtn = document.getElementById(`delete-${index}`);
      
      if (editBtn.classList.contains('show')) {
        editBtn.classList.remove('show');
        deleteBtn.classList.remove('show');
        menuToggle.classList.remove('hidden');
      } else {
        menuToggle.classList.add('hidden');
        editBtn.classList.add('show');
        deleteBtn.classList.add('show');
      }
    }

    function hideButtons(index) {
      const menuToggle = document.getElementById(`menu-${index}`);
      const editBtn = document.getElementById(`edit-${index}`);
      const deleteBtn = document.getElementById(`delete-${index}`);
      
      editBtn.classList.remove('show');
      deleteBtn.classList.remove('show');
      menuToggle.classList.remove('hidden');
    }

    document.addEventListener('click', function() {
      document.querySelectorAll('.action-btn').forEach(btn => {
        btn.classList.remove('show');
      });
      document.querySelectorAll('.menu-toggle').forEach(toggle => {
        toggle.classList.remove('hidden');
      });
    });

    function updatePSAOptions() {
      const plan = document.getElementById("plan").value;
      const serviceOption = document.getElementById("serviceOption");
      const currentValue = serviceOption.value;
      
      const isJapan = plan === "normal" || plan === "guarantee";
      
      if (isJapan) {
        serviceOption.innerHTML = `
          <option value="ãƒãƒªãƒ¥ãƒ¼ãƒãƒ«ã‚¯">ãƒãƒªãƒ¥ãƒ¼ãƒãƒ«ã‚¯</option>
          <option value="ãƒãƒªãƒ¥ãƒ¼">ãƒãƒªãƒ¥ãƒ¼</option>
          <option value="ãƒãƒªãƒ¥ãƒ¼ãƒ—ãƒ©ã‚¹">ãƒãƒªãƒ¥ãƒ¼ãƒ—ãƒ©ã‚¹</option>
          <option value="ãƒ¬ã‚®ãƒ¥ãƒ©ãƒ¼">ãƒ¬ã‚®ãƒ¥ãƒ©ãƒ¼</option>
          <option value="ãã‚Œä»¥å¤–">ãã‚Œä»¥å¤–</option>
        `;
      } else {
        serviceOption.innerHTML = `
          <option value="ãƒãƒªãƒ¥ãƒ¼ãƒãƒ«ã‚¯">ãƒãƒªãƒ¥ãƒ¼ãƒãƒ«ã‚¯</option>
          <option value="ãƒãƒªãƒ¥ãƒ¼">ãƒãƒªãƒ¥ãƒ¼</option>
          <option value="ãƒãƒªãƒ¥ãƒ¼ãƒ—ãƒ©ã‚¹">ãƒãƒªãƒ¥ãƒ¼ãƒ—ãƒ©ã‚¹</option>
          <option value="ãƒ¬ã‚®ãƒ¥ãƒ©ãƒ¼">ãƒ¬ã‚®ãƒ¥ãƒ©ãƒ¼</option>
          <option value="ãƒ‘ãƒƒã‚¯ãƒ»é›‘èªŒé‘‘å®š">ãƒ‘ãƒƒã‚¯ãƒ»é›‘èªŒé‘‘å®š</option>
          <option value="ç‰¹æ®Šé‘‘å®š">ç‰¹æ®Šé‘‘å®š</option>
          <option value="ãã‚Œä»¥å¤–">ãã‚Œä»¥å¤–</option>
        `;
      }
      
      const options = Array.from(serviceOption.options);
      const isCurrentValueAvailable = options.some(option => option.value === currentValue);
      
      if (isCurrentValueAvailable) {
        serviceOption.value = currentValue;
      } else {
        serviceOption.value = serviceOption.options[0].value;
      }
    }
    
    document.addEventListener("DOMContentLoaded", function () {
      originalPlanOptions = document.getElementById("plan").innerHTML;
      loadItems();
      updatePSAOptions();

      document.getElementById("plan").addEventListener("change", function() {
        updatePSAOptions();
        updateTotalSummary();
      });

      document.getElementById("serviceOption").addEventListener("change", function() {
        const serviceValue = this.value;
        const planSelect = document.getElementById("plan");
        const planSelectWrap = planSelect.closest('.select-wrap');
        const currentPlanValue = planSelect.value;
        
        if (serviceValue === "ãƒ‘ãƒƒã‚¯ãƒ»é›‘èªŒé‘‘å®š" || serviceValue === "ç‰¹æ®Šé‘‘å®š") {
          planSelect.innerHTML = `<option value="normal_usa">ãƒãƒ¼ãƒãƒ« ã‚¢ãƒ¡ãƒªã‚« (5%)</option>`;
          planSelect.value = "normal_usa";
          planSelect.disabled = true;
          planSelectWrap.classList.add('disabled');
        } else {
          planSelect.innerHTML = originalPlanOptions;
          planSelect.disabled = false;
          planSelect.value = currentPlanValue;
          planSelectWrap.classList.remove('disabled');
          updatePSAOptions();
        }
        updateTotalSummary();
      });

      document.getElementById("contactForm").addEventListener("submit", function (event) {
        event.preventDefault();
        showConfirmationScreen();
      });

      setupChoiceButtons();
      
      document.getElementById("finalSendBtn").addEventListener("click", function() {
        document.getElementById("confirmationScreen").style.display = "none";
        sendEmails();
      });
      
      document.getElementById("cancelBtn").addEventListener("click", function() {
        document.getElementById("confirmationScreen").style.display = "none";
      });
    });

    function setupChoiceButtons() {
      document.querySelectorAll('.choice-btn').forEach(button => {
        button.addEventListener('click', function() {
          const option = this.dataset.option;
          const value = this.dataset.value;
          const hiddenInput = document.getElementById(option);
          
          document.querySelectorAll(`[data-option="${option}"]`).forEach(btn => {
            btn.classList.remove('active');
          });
          
          this.classList.add('active');
          hiddenInput.value = value;
          saveFormToStorage();
        });
      });
    }

    document.getElementById("itemForm").addEventListener("submit", function (event) {
      event.preventDefault();
      saveItem();
    });

    function saveItem() {
      const itemName = document.getElementById("searchItem").value;
      const quantity = parseInt(document.getElementById("quantity").value);
      const declaredValue = parseFloat(document.getElementById("declaredValue").value);
      const acquisitionValue = parseFloat(document.getElementById("acquisitionValue").value) || 0;
      
      const item = { itemName, quantity, declaredValue, acquisitionValue };
      if (editIndex !== null) {
        updateItemInTable(editIndex, item);
        updateLocalStorage(editIndex, item);
        editIndex = null;
      } else {
        addItemToTable(item);
        saveToLocalStorage(item);
      }
      document.getElementById("itemForm").reset();
      updateTotalSummary();
    }

    function addItemToTable(item) {
      const tableBody = document.querySelector("#itemsTable tbody");
      const newRow = tableBody.insertRow();
      const rowCount = tableBody.rows.length;
      
      newRow.innerHTML = `
        <td>${rowCount}</td>
        <td class="card-name-cell">${truncateCardName(item.itemName)}</td>
        <td><span style="background: #f3f4f6; padding: 4px 8px; border-radius: 6px; font-weight: 600;">${item.quantity}</span></td>
        <td><span style="color: #059669; font-weight: 700;">Â¥${Number(item.declaredValue).toLocaleString()}</span></td>
        <td><span style="color: #0ea5e9; font-weight: 700;">${item.acquisitionValue ? 'Â¥' + Number(item.acquisitionValue).toLocaleString() : '-'}</span></td>
        <td>
          <div class="action-buttons">
            <button class="menu-toggle" onclick="toggleButtons(${rowCount - 1}, event)" id="menu-${rowCount - 1}">â‹®</button>
            <button class="action-btn edit" onclick="editItem(${rowCount - 1}); hideButtons(${rowCount - 1})" id="edit-${rowCount - 1}">ç·¨é›†</button>
            <button class="action-btn delete" onclick="confirmDelete(${rowCount - 1}); hideButtons(${rowCount - 1})" id="delete-${rowCount - 1}">å‰Šé™¤</button>
          </div>
        </td>
      `;
    }

    function updateItemInTable(index, item) {
      const tableBody = document.querySelector("#itemsTable tbody");
      const row = tableBody.rows[index];
      
      row.cells[1].innerHTML = truncateCardName(item.itemName);
      row.cells[1].className = "card-name-cell";
      row.cells[2].innerHTML = `<span style="background: #f3f4f6; padding: 4px 8px; border-radius: 6px; font-weight: 600;">${item.quantity}</span>`;
      row.cells[3].innerHTML = `<span style="color: #059669; font-weight: 700;">Â¥${Number(item.declaredValue).toLocaleString()}</span>`;
      row.cells[4].innerHTML = `<span style="color: #0ea5e9; font-weight: 700;">${item.acquisitionValue ? 'Â¥' + Number(item.acquisitionValue).toLocaleString() : '-'}</span>`;
    }

    function saveToLocalStorage(item) {
      let items = JSON.parse(localStorage.getItem("items")) || [];
      items.push(item);
      localStorage.setItem("items", JSON.stringify(items));
    }

    function updateLocalStorage(index, item) {
      let items = JSON.parse(localStorage.getItem("items")) || [];
      items[index] = item;
      localStorage.setItem("items", JSON.stringify(items));
    }

    function loadItems() {
      const items = JSON.parse(localStorage.getItem("items")) || [];
      items.forEach((item, index) => addItemToTable(item));
      updateTotalSummary();
    }

    function updateTotalSummary() {
      const totalQuantityElement = document.getElementById("totalQuantity");
      const totalFeeElement = document.getElementById("totalFee");
      
      let totalItems = 0;
      let totalDeclaredValue = 0;
      let totalAcquisitionValue = 0;
      
      const items = JSON.parse(localStorage.getItem("items")) || [];
      const plan = document.getElementById("plan").value;
      const serviceOption = document.getElementById("serviceOption").value;
      
      let feePercentage = 0;
      if (plan === "normal") {
        feePercentage = 0.022;
      } else if (plan === "guarantee") {
        feePercentage = 0.033;
      } else if (plan === "normal_usa") {
        if (serviceOption === "ãƒ‘ãƒƒã‚¯ãƒ»é›‘èªŒé‘‘å®š" || serviceOption === "ç‰¹æ®Šé‘‘å®š") {
          feePercentage = 0.05;
        } else {
          feePercentage = 0.033;
        }
      } else if (plan === "guarantee_usa") {
        feePercentage = 0.05;
      }
      
      items.forEach(item => {
        totalItems += item.quantity;
        totalDeclaredValue += item.declaredValue * item.quantity;
        totalAcquisitionValue += (item.acquisitionValue || 0);
      });
      
      const totalFeeValue = totalDeclaredValue * feePercentage;
      const gradingFee = calculateGradingFee(serviceOption, totalItems, plan);
      
      totalQuantityElement.innerText = totalItems + "æš";
      totalFeeElement.innerText = `Â¥${Math.round(totalFeeValue).toLocaleString()}`;
    }

    function showConfirmationScreen() {
      const items = JSON.parse(localStorage.getItem("items")) || [];
      let totalQuantityNum = 0;
      let totalDeclaredValue = 0;
      let totalAcquisitionValue = 0;
      
      const plan = document.getElementById("plan").value;
      const serviceOption = document.getElementById("serviceOption").value;
      
      let feePercentage = 0;
      if (plan === "normal") {
        feePercentage = 0.022;
      } else if (plan === "guarantee") {
        feePercentage = 0.033;
      } else if (plan === "normal_usa") {
        if (serviceOption === "ãƒ‘ãƒƒã‚¯ãƒ»é›‘èªŒé‘‘å®š" || serviceOption === "ç‰¹æ®Šé‘‘å®š") {
          feePercentage = 0.05;
        } else {
          feePercentage = 0.033;
        }
      } else if (plan === "guarantee_usa") {
        feePercentage = 0.05;
      }
      
      items.forEach(item => {
        totalQuantityNum += item.quantity;
        totalDeclaredValue += item.declaredValue * item.quantity;
        totalAcquisitionValue += (item.acquisitionValue || 0);
      });
      
      if ((plan === "guarantee" || plan === "guarantee_usa") && totalQuantityNum < 10) {
        alert("70ï¼…ä¿è¨¼ãƒ—ãƒ©ãƒ³ã‚’ã”åˆ©ç”¨ã®å ´åˆã€ã‚«ãƒ¼ãƒ‰ã¯10æšä»¥ä¸Šã®å…¥åŠ›ãŒå¿…è¦ã§ã™ã€‚");
        return;
      }
      
      const estimatedTax = totalAcquisitionValue * 0.15;
      const totalFeeValue = totalDeclaredValue * feePercentage;
      const gradingFee = calculateGradingFee(serviceOption, totalQuantityNum, plan);
      
      document.getElementById("confirmEstimatedTax").textContent = `Â¥${Math.round(estimatedTax).toLocaleString()}`;
      document.getElementById("confirmAgencyFee").textContent = `Â¥${Math.round(totalFeeValue).toLocaleString()}`;
      
      if (gradingFee !== null) {
        document.getElementById("confirmEstimatedGradingFee").textContent = `Â¥${gradingFee.toLocaleString()}`;
        document.getElementById("confirmTotalEstimatedFee").textContent = `Â¥${Math.round(totalFeeValue + gradingFee).toLocaleString()}`;
      } else {
        document.getElementById("confirmEstimatedGradingFee").textContent = "åˆ¥é€”è¦‹ç©ã‚‚ã‚Š";
        document.getElementById("confirmTotalEstimatedFee").textContent = "è¦‹ç©ã‚‚ã‚Šå¾Œã«è¡¨ç¤º";
      }
      
      const confirmationDetails = document.getElementById("confirmationDetails");
      confirmationDetails.innerHTML = `
        <div style="margin-bottom: 24px;">
          <h4 style="margin-bottom: 16px; color: #1a202c; font-weight: 700; text-align: left;">ğŸ“‹ åŸºæœ¬æƒ…å ±</h4>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
            <div style="text-align: left;"><strong>ãŠåå‰:</strong> ${document.getElementById("contactName").value}</div>
            <div style="text-align: left;"><strong>ãƒ¡ãƒ¼ãƒ«:</strong> ${document.getElementById("contactEmail").value}</div>
            <div style="text-align: left;"><strong>PSAãƒ—ãƒ©ãƒ³:</strong> ${document.getElementById("serviceOption").value}</div>
            <div style="text-align: left;"><strong>ä»£è¡Œãƒ—ãƒ©ãƒ³:</strong> ${document.getElementById("plan").options[document.getElementById("plan").selectedIndex].text}</div>
            <div style="text-align: left;"><strong>è²·å–é¡æç¤º:</strong> ${document.getElementById("purchaseOffer").value}</div>
            <div style="text-align: left;"><strong>è¿”å´æ–¹æ³•:</strong> ${document.getElementById("returnMethod").value}</div>
            <div style="text-align: left;"><strong>ç„¡æ–™æ¤œå“:</strong> ${document.getElementById("inspectionOption").value}</div>
            <div style="text-align: left;"><strong>ã‚«ãƒ¼ãƒ‰æšæ•°:</strong> ${totalQuantityNum}æš</div>
          </div>
        </div>
        
        <div style="margin-bottom: 24px;">
          <h4 style="margin-bottom: 16px; color: #1a202c; font-weight: 700; text-align: left;">ğŸ´ å…¥åŠ›ã‚«ãƒ¼ãƒ‰æƒ…å ±</h4>
          ${items.map((item, index) => `
            <div style="background: white; border: 1px solid #e5e7eb; padding: 12px; margin-bottom: 8px; border-radius: 8px;">
              <div style="text-align: left;">
                <div style="font-weight: 600; color: #1f2937; font-size: 14px; margin-bottom: 6px; line-height: 1.4; white-space: pre-line; max-width: 100%; word-break: break-word;">${index + 1}. ${truncateCardNameForConfirmation(item.itemName)}</div>
                <div style="display: flex; justify-content: space-between; font-size: 12px; color: #6b7280;">
                  <span>ç”³å‘Šé¡: Â¥${Number(item.declaredValue).toLocaleString()}</span>
                  <span>å–å¾—é¡: ${item.acquisitionValue ? 'Â¥' + Number(item.acquisitionValue).toLocaleString() : 'æœªè¨­å®š'}</span>
                  <span>æ•°é‡: ${item.quantity}æš</span>
                </div>
              </div>
            </div>
          `).join('')}
        </div>
      `;
      
      document.getElementById("confirmationScreen").style.display = "block";
    }

    function confirmDelete(index) {
      if (confirm("æœ¬å½“ã«ã“ã®ã‚«ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) {
        deleteFromLocalStorage(index);
        reloadTable();
      }
    }

    function deleteFromLocalStorage(index) {
      let items = JSON.parse(localStorage.getItem("items")) || [];
      items.splice(index, 1);
      localStorage.setItem("items", JSON.stringify(items));
    }

    function editItem(index) {
      let items = JSON.parse(localStorage.getItem("items")) || [];
      const item = items[index];
      document.getElementById("searchItem").value = item.itemName;
      document.getElementById("quantity").value = item.quantity;
      document.getElementById("declaredValue").value = item.declaredValue;
      document.getElementById("acquisitionValue").value = item.acquisitionValue || "";
      editIndex = index;

      const targetInput = document.getElementById("searchItem");
      targetInput.scrollIntoView({ behavior: "smooth", block: "center" });
      targetInput.focus();
    }

    function reloadTable() {
      const tableBody = document.querySelector("#itemsTable tbody");
      tableBody.innerHTML = "";
      loadItems();
    }

    document.getElementById("deleteDataButton").addEventListener("click", function () {
      if (confirm("æœ¬å½“ã«å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚")) {
        const tableBody = document.querySelector("#itemsTable tbody");
        tableBody.innerHTML = "";
        localStorage.removeItem("items");
        updateTotalSummary();
        document.getElementById("contactForm").reset();
        
        document.querySelectorAll('.choice-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelector('[data-option="purchaseOffer"][data-value="å¸Œæœ›ã—ãªã„"]').classList.add('active');
        document.querySelector('[data-option="returnMethod"][data-value="å³æ™‚è¿”é€"]').classList.add('active');
        document.querySelector('[data-option="inspectionOption"][data-value="å¸Œæœ›ã™ã‚‹"]').classList.add('active');
        
        document.getElementById('purchaseOffer').value = 'å¸Œæœ›ã—ãªã„';
        document.getElementById('returnMethod').value = 'å³æ™‚è¿”é€';
        document.getElementById('inspectionOption').value = 'å¸Œæœ›ã™ã‚‹';
      }
    });

    async function sendEmails() {
      const contactName = document.getElementById("contactName").value;
      const contactEmail = document.getElementById("contactEmail").value;
      const contactBody = document.getElementById("contactBody").value;
      const inspectionOption = document.getElementById("inspectionOption").value;
      const planElement = document.getElementById("plan");
      const planValue = planElement.value;
      const planText = planElement.options[planElement.selectedIndex].text;
      const purchaseOffer = document.getElementById("purchaseOffer").value;
      const returnMethod = document.getElementById("returnMethod").value;
      const serviceOption = document.getElementById("serviceOption").value;

      const items = JSON.parse(localStorage.getItem("items")) || [];
      let totalQuantityNum = 0;
      let totalDeclaredValue = 0;
      let totalAcquisitionValue = 0;
      
      items.forEach(item => { 
        totalQuantityNum += item.quantity;
        totalDeclaredValue += item.declaredValue * item.quantity;
        totalAcquisitionValue += (item.acquisitionValue || 0);
      });

      let feePercentage = 0;
      if (planValue === "normal") {
        feePercentage = 0.022;
      } else if (planValue === "guarantee") {
        feePercentage = 0.033;
      } else if (planValue === "normal_usa") {
        if (serviceOption === "ãƒ‘ãƒƒã‚¯ãƒ»é›‘èªŒé‘‘å®š" || serviceOption === "ç‰¹æ®Šé‘‘å®š") {
          feePercentage = 0.05;
        } else {
          feePercentage = 0.033;
        }
      } else if (planValue === "guarantee_usa") {
        feePercentage = 0.05;
      }

      const estimatedTax = totalAcquisitionValue * 0.15;
      const totalFeeValue = totalDeclaredValue * feePercentage;
      const gradingFee = calculateGradingFee(serviceOption, totalQuantityNum, planValue);

      const submitButton = document.querySelector('.btn-submit');
      submitButton.disabled = true;
      submitButton.innerHTML = '<span>â³</span> é€ä¿¡ä¸­...';
      submitButton.style.background = 'linear-gradient(135deg, #6b7280, #4b5563)';

      const requestData = {
        contactName,
        contactEmail,
        contactBody,
        plan: planText,
        serviceOption,
        purchaseOffer,
        returnMethod,
        inspectionOption,
        items,
        totalQuantity: `${totalQuantityNum}æš`,
        totalDeclaredValue,
        totalAcquisitionValue,
        totalFee: `Â¥${Math.round(totalFeeValue).toLocaleString()}`,
        estimatedTax: `Â¥${Math.round(estimatedTax).toLocaleString()}`,
        estimatedGradingFee: gradingFee !== null ? `Â¥${gradingFee.toLocaleString()}` : "åˆ¥é€”è¦‹ç©ã‚‚ã‚Š",
        totalEstimatedFee: gradingFee !== null ? `Â¥${Math.round(totalFeeValue + gradingFee).toLocaleString()}` : "è¦‹ç©ã‚‚ã‚Šå¾Œã«è¡¨ç¤º"
      };

      try {
        const response = await fetch('/api/rich-form-submit', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(requestData)
        });

        const result = await response.json();

        if (response.ok) {
          alert(`âœ… ${result.message}\n\nğŸ“„ ã”è«‹æ±‚äºˆå®šã®ä»£è¡Œæ‰‹æ•°æ–™: ${requestData.totalFee}\nğŸ’° é–¢ç¨è¦‹è¾¼ã¿é¡: ${requestData.estimatedTax}`);
          document.getElementById("confirmationMessage").style.display = "block";
          
          localStorage.removeItem("items");
          localStorage.removeItem("contactFormData");
          document.getElementById("contactForm").reset();
          reloadTable();
        } else {
          alert(`âŒ ${result.error}`);
        }
      } catch (error) {
        console.error('é€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
        alert('âŒ ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
      } finally {
        submitButton.disabled = false;
        submitButton.innerHTML = '<span>ğŸ“‹</span> å†…å®¹ã‚’ç¢ºèªã™ã‚‹';
        submitButton.style.background = 'linear-gradient(135deg, #10b981, #059669)';
      }
    }

    const formIds = [
      "serviceOption",
      "plan",
      "purchaseOffer",
      "returnMethod",
      "inspectionOption",
      "contactName",
      "contactEmail",
      "contactBody"
    ];

    function saveFormToStorage() {
      const data = {};
      formIds.forEach(id => {
        const el = document.getElementById(id);
        if (el) data[id] = el.value;
      });
      localStorage.setItem("contactFormData", JSON.stringify(data));
    }

    function loadFormFromStorage() {
      const data = JSON.parse(localStorage.getItem("contactFormData") || "{}");
      formIds.forEach(id => {
        const el = document.getElementById(id);
        if (el && typeof data[id] !== "undefined") {
          el.value = data[id];
          
          if (["purchaseOffer", "returnMethod", "inspectionOption"].includes(id)) {
            document.querySelectorAll(`[data-option="${id}"]`).forEach(btn => {
              btn.classList.remove('active');
              if (btn.dataset.value === data[id]) {
                btn.classList.add('active');
              }
            });
          }
          
          if (el.tagName === "SELECT" && ![...el.options].some(opt => opt.value === data[id])) {
            el.selectedIndex = 0;
          }
        }
      });
      updateTotalSummary();
    }

    function clearFormStorage() {
      localStorage.removeItem("contactFormData");
    }

    document.addEventListener("DOMContentLoaded", function () {
      loadFormFromStorage();

      formIds.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
          el.addEventListener("change", saveFormToStorage);
          el.addEventListener("input", saveFormToStorage);
        }
      });

      document.getElementById("deleteDataButton").addEventListener("click", function () {
        clearFormStorage();
        formIds.forEach(id => {
          const el = document.getElementById(id);
          if (el && el.tagName === "SELECT") el.selectedIndex = 0;
          if (el && (el.tagName === "INPUT" || el.tagName === "TEXTAREA")) el.value = "";
        });
      });
    });
  </script>
</body>
</html>
